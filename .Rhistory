lnL<-sapply(lossgainjump_fits,logLik)
lnL
## new best model
squamate_lossgain_jump<-lossgainjump_fits[[which.max(lnL)]]
## stop cluster
stopCluster(cl=mc)
## re-run comparison
anova(
squamate_er,
squamate_lossonly_1r,
squamate_lossgain_2r,
squamate_lossonly_5r,
squamate_lossonly_jump,
squamate_lossgain_10r,
squamate_lossgain_jump)
squamate_lossgain_jump
squamate_lossgain_10r
niter<-30 ## number of iterations
ncores<-min(niter,detectCores()-4) ## number of cores (leave 4 free)
mc<-makeCluster(ncores,type="PSOCK")
registerDoParallel(cl=mc)
lossgainjump_fits<-foreach(i=1:niter)%dopar%{
phytools::fitMk(squamate_tree,hind_digits,
model=D,pi="fitzjohn",rand_start=TRUE,
lik.func="lik",logscale=FALSE) #sample(c(TRUE,FALSE),1))
}
## get log-likelihoods
lnL<-sapply(lossgainjump_fits,logLik)
lnL
## new best model
squamate_lossgain_jump<-lossgainjump_fits[[which.max(lnL)]]
## stop cluster
stopCluster(cl=mc)
## re-run comparison
anova(
squamate_er,
squamate_lossonly_1r,
squamate_lossgain_2r,
squamate_lossonly_5r,
squamate_lossonly_jump,
squamate_lossgain_10r,
squamate_lossgain_jump)
squamate_lossgain_jump
lnL
niter<-30 ## number of iterations
ncores<-min(niter,detectCores()-4) ## number of cores (leave 4 free)
mc<-makeCluster(ncores,type="PSOCK")
registerDoParallel(cl=mc)
## loss/gain + jump design matrix
D<-matrix(c(
0,7,0,0,0,0,
1,0,8,0,0,0,
6,2,0,9,0,0,
6,0,3,0,10,0,
6,0,0,4,0,11,
6,0,0,0,5,0),
6,6,byrow=TRUE,
dimnames=list(0:5,0:5))
lossgainjump_fits<-foreach(i=1:niter)%dopar%{
phytools::fitMk(squamate_tree,hind_digits,
model=D,pi="fitzjohn",rand_start=TRUE,
lik.func="lik",logscale=TRUE)
}
## get log-likelihoods
lnL<-sapply(lossgainjump_fits,logLik)
lnL
## new best model
squamate_lossgain_jump<-lossgainjump_fits[[which.max(lnL)]]
## stop cluster
stopCluster(cl=mc)
## re-run comparison
anova(
squamate_er,
squamate_lossonly_1r,
squamate_lossgain_2r,
squamate_lossonly_5r,
squamate_lossonly_jump,
squamate_lossgain_10r,
squamate_lossgain_jump)
lnL
save.image("C:/Users/liamj/Dropbox/courses/BIOL634-fall2025/hw/4/hw4-solution.RData")
library(geiger)
tree<-pbtree(n=10)
x<-sim.char(tree)
x<-sim.char(tree,par=list(sigma=0.5))
x<-sim.char(tree,par=0.5)
x
?sim.char
?rTraitCont
?fastBM
?fastBM
tree<-pbtree(n=100,scale=1)
x<-fastBM(tree,alpha=1)
x<-fastBM(tree,alpha=1,theta=0)
geiger::fitContinuous(tree,x)
geiger::fitContinuous(tree,x,model="OU")
?rTraitCont
?fastBM
tree<-pbtree(n=500,scale=1)
x<-fastBM(tree,alpha=1,theta=0)
geiger::fitContinuous(tree,x,model="OU")
?rTraitCont
?fastBM
tree<-pbtree(n=1000,scale=1)
x<-fastBM(tree,alpha=0.5,theta=0)
geiger::fitContinuous(tree,x,model="OU")
?rTraitCont
?fastBM
tree<-pbtree(n=2000,scale=1)
x<-fastBM(tree,alpha=0.5,theta=0)
geiger::fitContinuous(tree,x,model="OU")
?rTraitCont
?fastBM
tree<-pbtree(n=2000,scale=1)
x<-fastBM(tree,alpha=0.8,theta=0)
geiger::fitContinuous(tree,x,model="OU")
?rTraitCont
?fastBM
tree<-pbtree(n=5000,scale=1)
x<-fastBM(tree,alpha=0.8,theta=0)
geiger::fitContinuous(tree,x,model="OU")
tree<-pbtree(N=100,b=1,d=0.3)
tree<-pbtree(n=100,b=1,d=0.3)
tree
library(phangorn)
howmanytrees()
howmanytrees(10)
howmanytrees(20)
?howmanytrees
phangorn::howmanytrees(n=15)
## load packages
library(phytools)
library(geiger)
## load some data
data("cordylid.tree")
## plot this tree
plotTree(cordylid.tree,ftype="i")
## plot this tree
plotTree(cordylid.tree,ftype="i",fsize=0.9)
args(nodelabels)
nodelabels(cex=0.6,frame="circle",bg="white")
## load in my data
data("cordylid.data")
head(cordylid.data)
##
cordylid_armoring<-setNames(cordylid.data$pPC1,
rownames(cordylid.data))
cordylid_armoring
## estimate ML ancestral states using fastAnc
cordylid_ml<-fastAnc(cordylid.tree,cordylid_armoring)
cordylid_ml
## estimate ML ancestral states using fastAnc
cordylid_ml<-fastAnc(cordylid.tree,cordylid_armoring,
CI=TRUE)
cordylid_ml
## compare 95% CI on root to range of trait
range(cordylid_armoring)
## visualize our reconstruction using contMap
cordylid_cmap<-contMap(cordylid.tree,cordylid_armoring,
plot=FALSE)
cordylid_cmap
plot(cordylid_cmap)
plot(cordylid_cmap,fsize=0.8)
## update our color gradient
cordylid_cmap<-setMap(cordylid_cmap,hcl.colors(n=100))
plot(cordylid_cmap,fsize=0.8)
nodelabels(cex=0.6,frame="circle",bg="white")
## let's Bayesian MCMC ancestral state reconstruction
cordylid_mcmc<-anc.Bayes(cordylid.tree,
cordylid_armoring,ngen=500000)
anc.Bayes
## informative prior on the root
Prior_mean<-c(1000,min(cordylid_armoring),
rep(mean(cordylid_armoring,cordylid.tree$Nnode)))
Prior_mean
## informative prior on the root
Prior_mean<-c(1000,min(cordylid_armoring),
rep(mean(cordylid_armoring),cordylid.tree$Nnode))
Prior_mean
var(cordylid_armoring)
Prior_var<-c(1e6,0.25,rep(1000,cordylid.tree$Nnode-1))
cordylid_mcmc.informative<-anc.Bayes(cordylid.tree,
cordylid_armoring,ngen=500000,
control=list(pr.mean=Prior_mean,pr.var=Prior_var))
cordylid_mcmc.informative$ace
cordylid_mcmc.informative
Prior_var<-c(1e6,0.01,rep(1000,cordylid.tree$Nnode-1))
cordylid_mcmc.informative<-anc.Bayes(cordylid.tree,
cordylid_armoring,ngen=500000,
control=list(pr.mean=Prior_mean,pr.var=Prior_var))
cordylid_mcmc.informative
cordyld_mcmc
cordylid_mcmc
dev.off()
cordylid_ml
str(cordylid_mcmc)
obj<-print(cordylid_mcmc)
str(obj)
plot(cordylid_ml$ace,obj)
plot(cordylid_ml$ace,obj,bty="n",pch=21,pt.bg="grey",
xlab="ML estimates",ylab="Bayesian estimates")
plot(cordylid_ml$ace,obj,bty="n",pch=21,bg="grey",
xlab="ML estimates",ylab="Bayesian estimates")
plot(cordylid_ml$ace,obj,bty="n",pch=21,bg="grey",
xlab="ML estimates",ylab="Bayesian estimates",
las=1)
grid()
min(cordylid_armoring)
cordylid.tree$Nnode
## let's specify an informative prior
Prior_mean<-c(
1000,
min(cordylid_armoring),
rep(mean(cordylid_armoring),cordylid.tree$Nnode-1))
var(cordylid_armoring)
Prior_var<-c(
1e6,
0.01,
rep(1000,cordylid.tree$Nnode-1))
cordylid_mcmc.informative<-anc.Bayes(cordylid.tree,
cordylid_armoring,ngen=500000,
control=list(pr.mean=Prior_mean,
pr.var=Prior_var))
cordylid_mcmc.informative
obj<-print(cordylid_mcmc.informative)
plot(cordylid_ml$ace,obj,bty="n",pch=21,bg="grey",
xlab="ML estimates",ylab="Bayesian estimates (informative prior)",
las=1)
grid()
cordylid_cmap.bayes<-contMap(cordylid_tree,
cordylid_armoring,anc.states=obj$ace,plot=FALSE)
cordylid_cmap.bayes<-contMap(cordylid.tree,
cordylid_armoring,anc.states=obj$ace,plot=FALSE)
cordylid_cmap.bayes<-contMap(cordylid.tree,
cordylid_armoring,anc.states=obj$ace,plot=FALSE)
cordylid_cmap.bayes<-setMap(cordylid_cmap.bayes,
hcl.colors(n=100))
plot(cordylid_cmap.bayes,fsize=0.8)
cordylid_cmap.bayes<-contMap(cordylid.tree,
cordylid_armoring,anc.states=obj,plot=FALSE)
cordylid_cmap.bayes<-setMap(cordylid_cmap.bayes,
hcl.colors(n=100))
plot(cordylid_cmap.bayes,fsize=0.8)
dev.off()
obj<-print(cordylid_mcmc.informative)
plot(cordylid_ml$ace,obj,bty="n",pch=21,bg="grey",
xlab="ML estimates",ylab="Bayesian estimates (informative prior)",
las=1)
grid()
cordylid_cmap.bayes<-contMap(cordylid.tree,
cordylid_armoring,anc.states=obj,plot=FALSE)
cordylid_cmap.bayes<-setMap(cordylid_cmap.bayes,
hcl.colors(n=100))
plot(cordylid_cmap.bayes,fsize=0.8)
cordylid_cmap.bayes<-contMap(cordylid.tree,
cordylid_armoring,method="user",
anc.states=obj,plot=FALSE)
cordylid_cmap.bayes<-setMap(cordylid_cmap.bayes,
hcl.colors(n=100))
plot(cordylid_cmap.bayes,fsize=0.8)
plot(cordylid_cmap,ftype="off")
par(mfrow=c(1,2))
plot(cordylid_cmap,ftype="off")
plot(cordylid_cmap.bayes,ftype="off",
direction="leftwards")
plot(cordylid_cmap,ftype="off",fsize=0.6)
plot(cordylid_cmap.bayes,ftype="off",
direction="leftwards",fsize=0.6)
dev.off()
plot(cordylid_cmap.bayes,ftype="off",
direction="leftwards",fsize=0.6)
plot(cordylid_cmap.bayes,ftype="off",
direction="rightwards",fsize=0.6)
nodelabels(frame="circle",cex=0.6)
cordylid_node.42<-density(cordylid_mcmc.informative,what=42)
dev.off()
plot(cordylid_node.42)
cordylid_node.42
## load primate data
data(primate.tree)
data(primate.data)
## pull out our character
activity<-setNames(primate.data$Activity_pattern,
rownames(primate.data))
activity
## fit three models: ER, SYM, ARD models
er_primates<-fitMk(primate.tree,activity,
model="ER")
sym_primates<-fitMk(primate.tree,activity,
model="SYM")
ard_primates<-fitMk(primate.tree,activity,
model="ARD")
## traditionally, we would compare these three
## models and choose the "best"
anova(er_primates,
sym_primates,
ard_primates)
## estimate marginal ancestral states under
## "best" (i.e., ER) model
primate_er.marginal<-ancr(er_primates)
primate_er.marginal
## we can plot this
plot(primate_er.marginal)
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("yellow","pink","purple")))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("pink","yellow","purple")))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("pink","yellow","navy")))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("pink","gold","navy")))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards",type="fan"),
args.nodelabels=list(piecol=c("pink","gold","navy")))
## we can plot this
plot(primate_er.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("pink","gold","navy")))
## re-calculate our model comparison
anova(er_primates,
sym_primates,
ard_primates)->aov_primates
aov_primates
primate_modelaveraged.marginal<-ancr(aov_primates)
primate_modelaveraged.marginal
plot(primate_modelaveraged.marginal,
args.plotTree=list(direction="upwards"),
args.nodelabels=list(piecol=c("pink","gold","navy")))
getwd()
setwd("courses/Israel-2025/work")
## download our data files
download.file(
url="https://liamrevell.github.io/hula2025/data/SJ_ComMatrix.csv",
destfile="SJ_ComMatrix.csv")
download.file(
url="https://liamrevell.github.io/hula2025/data/SJtree.phy",
destfile="SJtree.phy")
## read in my tree first
SJ_tree<-read.tree(file="SJtree.phy")
## load libraries
library(phytools)
## read in my tree first
SJ_tree<-read.tree(file="SJtree.phy")
SJ_tree
plotTree(SJ_tree,ftype="off",lwd=1)
## read in my data
SJ_data<-read.csv(file="SJ_ComMatrix.csv",row.names=1)
head(SJ_data,2)
## plot our presence/absence data
plotTree.datamatrix(SJ_tree,SJ_data)
?plotTree.datamatrix
## plot fan tree
plotFanTree.wTraits(SJ_tree,SJ_data,type="fan")
## plot fan tree
plotFanTree.wTraits(SJ_tree,SJ_data,type="fan",ftype="off")
## plot our presence/absence data
?par
par()
par()$fg
par(fg="transparent")
plotTree.datamatrix(SJ_tree,SJ_data)
par(fg="black")
plotTree.datamatrix(SJ_tree,SJ_data)
palette()
palette()[c(4,2)]
ncol(SJ_data)
palette()[c(4,2)]
setNames(palette()[c(4,2)],0:1)
cols<-replicate(ncol(SJ_data),
setNames(palette()[c(4,2)],0:1),
simplify=FALSE)
cols
palette()
cols<-replicate(ncol(SJ_data),
setNames(c("forestgreen","lightblue"),0:1),
simplify=FALSE)
cols
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols)
par(fg="transparent")
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols)
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols,
fsize=0,xexp=1.6,yexp=1)
cols<-replicate(ncol(SJ_data),
setNames(c("lightblue","forestgreen"),0:1),
simplify=FALSE)
cols
par(fg="transparent")
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols,
fsize=0,xexp=1.6,yexp=1)
par(fg="black")
legend("bottomleft",legend=c("absent","present"),
pch=22,pt.bg=c("lightblue","forestgreen"),bty="n")
par(fg="transparent")
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols,
fsize=0,xexp=1.6,yexp=1)
par(fg="black")
legend("bottomleft",legend=c("absent","present"),
pch=22,pt.bg=c("lightblue","forestgreen"),bty="n",
pt.cex=2)
## install picante
install.packages("picante")
args(pdf)
pdf(file="SJ_community_tree_plot.pdf",
width=10,height=10)
par(fg="transparent")
plotTree.datamatrix(SJ_tree,SJ_data,colors=cols,
fsize=0,xexp=1.6,yexp=1)
par(fg="black")
legend("bottomleft",legend=c("absent","present"),
pch=22,pt.bg=c("lightblue","forestgreen"),bty="n",
pt.cex=2)
dev.off()
?par
par()$fin
## load picante
?pd
## calculate PD
?pd
## load picante
library(picante)
## calculate PD
?pd
SJ_all_pd<-pd(t(SJ_data),SJ_tree,include.root=TRUE)
head(SJ_all_pd)
dev.off()
plot(SJ_all_pd[,2:1])
plot(SJ_all_pd[,2:1],bty="n",pch=21,bg="grey",
las=1,cex.axis=0.8)
plot(SJ_all_pd[,2:1],bty="n",pch=21,bg="grey",
las=1,cex.axis=0.8,xlab="species richness",
ylab="phylogenetic diversity")
grid()
Ntip(SJ_tree)
head(SJ_all_pdf)
head(SJ_all_pd)
SJ_data[,"Aleck_Rock"]
SJ_data[,"Aleck_Rock",drop=FALSE]
sample(SJ_data[,"Aleck_Rock"])
sample(SJ_data[,"Aleck_Rock"])
sum(sample(SJ_data[,"Aleck_Rock"]))
sum(sample(SJ_data[,"Aleck_Rock"]))
sum(sample(SJ_data[,"Aleck_Rock"]))
args(matrix)
null_Aleck_Rock<-matrix(0,nrow=nrow(SJ_data),
ncol=1000,
dimnames=list(rownames(SJ_data),
paste("perm",1:1000,sep="")))
dim(null)
dim(null_Aleck_Rock)
head(rownames(null_Aleck_Rock))
head(colnames(null_Aleck_Rock))
null_Aleck_Rock[,1]<-SJ_data[,"Aleck_Rock"]
for(i in 2:ncol(null_Aleck_Rock)){
null_Aleck_Rock[,i]<-sample(SJ_data[,"Aleck_Rock"])
}
null_pd.Aleck_Rock<-pd(t(null_Aleck_Rock),SJ_tree)
head(null_pd.Aleck_Rock)
hist(null_pd.Aleck_Rock$PD,breaks=20)
abline(v=SJ_all_pd["Aleck_Rock","PD"])
abline(v=SJ_all_pd["Aleck_Rock","PD"],lwd=3,col="red")
SJ_data[,"Posey_Island"]
null_Posey_Island<-matrix(0,nrow=nrow(SJ_data),
ncol=1000,
dimnames=list(rownames(SJ_data),
paste("perm",1:1000,sep="")))
dim(null_Posey_Island)
null_Posey_Island[,1]<-SJ_data[,"Posey_Island"]
for(i in 2:ncol(null_Posey_Island)){
null_Posey_Island[,i]<-sample(SJ_data[,"Posey_Island"])
}
null_pd.Posey_Island<-pd(t(null_Posey_Island),SJ_tree)
head(null_pd.Posey_Island)
hist(null_pd.Posey_Island$PD,breaks=20)
abline(v=SJ_all_pd["Posey_Island","PD"],lwd=3,
col="red")
?ses.pd
ses.pd(t(SJ_data),SJ_tree,null.model="richness")
SJ_pd.test<-ses.pd(t(SJ_data),SJ_tree,
null.model="richness")
head(SJ_pd.test)
hist(SJ_pd.test$pd.obs.z,breaks=20)
?comdist
?cophenetic
?cophenetic.phylo
SJ_cophenetic<-cophenetic(SJ_tree)
dim(SJ_cophenetic)
SJ_comdist<-comdist(t(SJ_data),SJ_cophenetic)
SJ_comdist
view(SJ_comdist)
View(SJ_comdist)
SJ_community_dendro<-hclust(SJ_comdist)
plot(SJ_community_dendro)
plot(SJ_community_dendro,cex=0.5)
plot(SJ_community_dendro,cex=0.4)
getwd()
setwd("../hula2025/")
data("vertebrate.tree")
vertebrate.tree
getwd()
write.tree(vertebrate.tree,file="data/vertebrate.tre")
